/* ------------------------------------------
 * translate Helper
 *------------------------------------------- */
// Doc about message format : http://userguide.icu-project.org/formatparse/messages
// import { parse } from 'intl-messageformat-parser';
const fs = require('fs');
const glob = require('glob');
const mkdirp = require('mkdirp');
const isEmpty = require('lodash/isEmpty');
const rimraf = require('rimraf');

const config = require('../config');
const logger = require('../utils/logger');

const { utils: { paths }, i18n: { locales } } = config;
const mkdirpSync = mkdirp.sync;
const globSync = glob.sync;

const AVAILABLE_LOCALES = locales;
const ORIGIN_PATH = paths.i18n('origin');
const EXPORT_DIR = paths.distStatic('locales');
const DOC_DIR = paths.i18n('documentation');
const DOC_FILE = paths.i18n('documentation', 'all.json');

const makeLocalePath = locale => `${EXPORT_DIR}/${locale}.json`;
const makeGlob = path => `${path}/**/*.json`;

/**
 * Delete origin content on error
 * @param cb
 */
const emptyOriginDirectory = cb => {
  rimraf(`${ORIGIN_PATH}/*`, () => {
    cb.call(null);
  });
};

/**
 * Load keys generated by Intl
 * @returns {{}}
 */
const loadOriginKeys = () => {
  const files = globSync(makeGlob(ORIGIN_PATH));
  if (!files || files.length < 1) {
    throw new Error('Empty localization index');
  }
  return files.map(filename => fs.readFileSync(filename, 'utf8'))
    .map(file => JSON.parse(file));
};

/**
 * Extract message map from origin export
 * @param all
 * @returns {{}}
 */
const extractAllMessages = all => all.reduce((collection, descriptors) => ({
  ...collection,
  ...descriptors.reduce((acc, item) => {
    if (Object.prototype.hasOwnProperty.call(collection, item.id)) {
      emptyOriginDirectory(() => {
        throw new Error(`Duplicate message id: ${item.id}`);
      });
    }
    return {
      ...acc,
      [item.id]: {
        ...item,
      },
    };
  }, {}),
}), {});

/**
 * Inflate extracted values from intl API to a human readable mapper
 * @param mapper
 */
const applyDefaultLocaleKeys = mapper => Object.keys(mapper).reduce((acc, next) => ({
  ...acc,
  [next]: {
    ...mapper[next],
    locales: AVAILABLE_LOCALES.reduce((prev, curr) => ({
      ...prev,
      [curr]: mapper[next].defaultMessage,
    }), {}),
  },
}), {});

/**
 * Load human localized keys
 * @returns {{}}
 */
const loadFinalKeys = () => {
  if (fs.existsSync(DOC_FILE)) {
    return JSON.parse(fs.readFileSync(DOC_FILE, 'utf-8'));
  }
  return {};
};

/**
 * Merge extracted and human keys
 * @param generated
 * @param humanized
 */
const mergePreviousAndCurrent = (generated, humanized) =>
  Object.keys(generated).reduce((acc, id) => ({
    ...acc,
    [id]: {
      ...generated[id],
      locales: Object.keys(generated[id].locales)
        .reduce((col, locale) => ({
          ...col,
          [locale]: humanized[id] && humanized[id].locales[locale]
            ? humanized[id].locales[locale]
            : generated[id].locales[locale],
        })
          , {}),
    },
  }), {});

/**
 * Export locales to allow the app to translate labels
 * @param mapper
 */
const exportLocales = mapper => {
  mkdirpSync(EXPORT_DIR);
  AVAILABLE_LOCALES.forEach(locale => {
    logger.cyan(`‚úÖ   Export for locale ${locale.toUpperCase()}`);
    const localizedKeys = Object.keys(mapper)
      .reduce((acc, id) => ({
        ...acc,
        [id]: mapper[id].locales[locale],
      }), {});
    fs.writeFileSync(
      makeLocalePath(locale),
      JSON.stringify(localizedKeys, null, 2)
    );
  });
};

module.exports = function exportTranslations() {
  logger.line('cyan', 'üåê  ');
  logger.cyan('Start translation builder');
  logger.line('cyan');
  mkdirpSync(DOC_DIR);
  const inflated = applyDefaultLocaleKeys(extractAllMessages(loadOriginKeys()));
  const humanized = loadFinalKeys();
  let finalResult = inflated;
  if (!isEmpty(humanized)) {
    finalResult = mergePreviousAndCurrent(inflated, humanized);
  }
  exportLocales(finalResult);
  logger.dots('cyan');
  logger.cyan('‚úÖ   Export final documentation');
  fs.writeFileSync(
    DOC_FILE,
    JSON.stringify(finalResult, null, 2)
  );
  logger.line('green', 'ü§ò  ');
  logger.green('Translation built success');
  logger.line('green');
};
